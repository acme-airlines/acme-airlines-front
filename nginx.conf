# /etc/nginx/conf.d/acmeairlines.conf

upstream api_backend {
    server api-acmeairlines.duckdns.org:443;
}

server {
    listen              4200 ssl http2;
    server_name         localhost;

    # SSL certificate & key (self-signed or mkcert)
    ssl_certificate     /etc/nginx/ssl/localhost.crt;
    ssl_certificate_key /etc/nginx/ssl/localhost.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    root   /usr/share/nginx/html;
    index  index.html;

    # ——————————————————————————————————————————————
    # Proxy rules for your APIs
    # ——————————————————————————————————————————————

    location ^~ /auth/ {
        proxy_pass         https://api_backend/oauth/api/v1/public/auth/;
        proxy_ssl_server_name on;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location ^~ /document-type/ {
        proxy_pass         https://api_backend/passengers/api/v1/document-type/;
        proxy_ssl_server_name on;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location ^~ /passenger/ {
        proxy_pass         https://api_backend/passengers/api/v1/passenger/;
        proxy_ssl_server_name on;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location ^~ /cities/ {
        proxy_pass         https://api_backend/flights/api/v1/public/cities/;
        proxy_ssl_server_name on;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location ^~ /flights/ {
        proxy_pass         https://api_backend/flights/api/v1/public/flights/;
        proxy_ssl_server_name on;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location ^~ /fees/ {
        proxy_pass         https://api_backend/tariff/api/v1/fees/;
        proxy_ssl_server_name on;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location ^~ /service-fee/ {
        proxy_pass         https://api_backend/tariff/api/v1/service-fee/;
        proxy_ssl_server_name on;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location ^~ /user/ {
        proxy_pass         https://api_backend/passengers/api/v1/user/;
        proxy_ssl_server_name on;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    location ^~ /service-passenger/ {
        proxy_pass         https://api_backend/tariff/api/v1/service-passenger/;
        proxy_ssl_server_name on;
        proxy_set_header   Host              $host;
        proxy_set_header   X-Real-IP         $remote_addr;
        proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # ——————————————————————————————————————————————
    # SPA fallback for Angular routes
    # ——————————————————————————————————————————————

    location / {
        try_files $uri $uri/ /index.html;
    }

    # ——————————————————————————————————————————————
    # Gzip compression for static assets
    # ——————————————————————————————————————————————

    gzip on;
    gzip_types
      text/plain
      text/css
      application/json
      application/javascript
      text/xml
      application/xml
      application/xml+rss
      text/javascript;
}
